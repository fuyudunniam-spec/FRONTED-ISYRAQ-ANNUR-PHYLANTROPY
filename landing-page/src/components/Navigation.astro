---
import { client, queries, urlFor } from '../lib/sanity';

interface Props {
    activeRoute?: string;
}

const { activeRoute = '/' } = Astro.props;

// Fetch navigation from Sanity
let siteSettings: any = null;
let navLinks: any[] = [];

try {
    siteSettings = await client.fetch(queries.siteSettings);
    navLinks = (siteSettings?.mainNavigation || []).map((item: any) => {
        // Map old links to new structure
        if (item.link === '/tentang-kami') return { ...item, link: '/isyraq-annur-philanthropy/about-us' };
        if (item.link === '/donasi') return { ...item, link: '/isyraq-annur-philanthropy/donasi' };
        if (item.link === '/psb') return { ...item, link: 'https://pesantren-albisri.vercel.app/psb' };
        if (item.link === '/transparansi') return { ...item, link: '/isyraq-annur-philanthropy/transparansi' };
        if (item.link === '/berita') return { ...item, link: '/isyraq-annur-philanthropy/berita' };
        if (item.link === '/') return { ...item, link: '/isyraq-annur-philanthropy' };
        return item;
    }).filter((item: any) => item.title.toLowerCase() !== 'academy' && item.title.toLowerCase() !== 'akademi');
} catch (error) {
    console.error('Failed to fetch navigation from Sanity:', error);
    navLinks = [
        { title: 'Beranda', link: '/isyraq-annur-philanthropy', isButton: false },
        { title: 'Tentang', link: '/isyraq-annur-philanthropy/about-us', isButton: false },
        { title: 'Wakaf', link: '/isyraq-annur-philanthropy/donasi', isButton: false },
        { title: 'Berita', link: '/isyraq-annur-philanthropy/berita', isButton: false },
        { title: 'Daftar Santri', link: 'https://pesantren-albisri.vercel.app/psb', isButton: true },
    ];
}

const siteTitle = siteSettings?.title || 'AL-BISRI';
const logoImage = siteSettings?.logo;
---

<nav class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-md border-b border-stone-200 shadow-sm transition-all duration-300">
    <div class="max-w-7xl mx-auto px-6 h-20 grid grid-cols-12 items-center gap-4">
        <!-- Logo -->
        <div class="col-span-6 lg:col-span-3 flex justify-start items-center">
            <a href="/isyraq-annur-philanthropy" class="flex items-center group">
                <div class="h-16 flex items-center overflow-visible">
                    <img 
                        src="/images/logo-isyraq.png" 
                        alt="Isyraq Annur Media"
                        class="h-40 w-auto object-contain transform transition-all duration-300 group-hover:scale-105 -my-8"
                    />
                </div>
            </a>
        </div>

        <!-- Desktop Navigation -->
        <div class="hidden lg:flex col-span-6 justify-center items-center gap-8">
            {navLinks.filter((item: any) => !item.isButton).map((item: any) => (
                <a 
                    href={item.link}
                    class={`text-sm uppercase tracking-widest font-bold transition border-b-2 pb-1 ${
                        activeRoute === item.link 
                            ? 'text-royal-900 border-gold-400' 
                            : 'text-stone-600 hover:text-royal-900 border-transparent hover:border-gold-400'
                    }`}
                >
                    {item.title}
                </a>
            ))}
        </div>

        <!-- CTA Buttons -->
        <div class="col-span-6 lg:col-span-3 flex justify-end items-center gap-4">
            {navLinks.find((item: any) => item.isButton) && (
                <a href={navLinks.find((item: any) => item.isButton)?.link || '/psb'} class="hidden xl:flex items-center gap-2 text-stone-500 hover:text-royal-900 text-xs font-bold uppercase tracking-wider transition">
                    <i data-lucide="user-plus" class="w-3 h-3"></i> {navLinks.find((item: any) => item.isButton)?.title || 'Daftar'}
                </a>
            )}
            <a href="/isyraq-annur-philanthropy/donasi" class="group flex items-center gap-2 px-5 py-2 bg-royal-900 text-white text-[11px] uppercase tracking-widest font-semibold hover:bg-royal-800 transition shadow-lg shadow-royal-900/20 rounded-sm">
                <span>Investasi Wakaf</span>
                <i data-lucide="heart" class="w-3 h-3 text-gold-400 fill-current group-hover:scale-110 transition-transform"></i>
            </a>
            <button id="mobile-menu-button" class="lg:hidden text-royal-900 p-2">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden lg:hidden bg-white border-t border-stone-100 px-6 py-4">
        <div class="space-y-3">
            {navLinks.map((item: any) => (
                <a 
                    href={item.link}
                    class={`block py-2 text-sm uppercase tracking-widest font-bold ${
                        item.isButton 
                            ? 'text-white bg-royal-900 px-4 py-3 rounded text-center mt-4' 
                            : activeRoute === item.link 
                                ? 'text-royal-900' 
                                : 'text-stone-600 hover:text-royal-900'
                    } transition`}
                >
                    {item.title}
                </a>
            ))}
        </div>
    </div>
</nav>

<script is:inline>
    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
        const menuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        if (menuButton && mobileMenu) {
            menuButton.addEventListener('click', function() {
                mobileMenu.classList.toggle('hidden');
            });
        }
    });
</script>
